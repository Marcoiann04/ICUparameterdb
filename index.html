<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Estrazione parametri ICU</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    textarea, pre { width: 100%; min-height: 100px; margin-top: 1em; font-family: monospace; }
    #output { background: #f0f0f0; padding: 1em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Estrazione parametri ICU da immagine</h1>

  <input type="file" id="imageInput">
  <button onclick="processImage()">Estrai parametri</button>

  <div id="output"></div>

  <script>
    async function processImage() {
      const file = document.getElementById('imageInput').files[0];
      if (!file) return alert('Carica prima un'immagine');

      document.getElementById('output').textContent = 'Estrazione in corso...';

      const result = await Tesseract.recognize(file, 'eng', {
        tessedit_char_whitelist: '0123456789.,:/Â°%+-MmHgLlABCDEFabcdef',
      });

      let text = result.data.text.trim();
      const rows = text.split(/\n+/).map(r => r.trim()).filter(Boolean);

      // Ordine logico dei parametri
      const parametriEstratti = {
        "PA Max": "",
        "PA Min": "",
        "MAP": "",
        "FC Ritmo": "",
        "PVC": "",
        "PAP Max": "",
        "PAP Min": "",
        "PAP Media": "",
        "T Perif": "",
        "T Int": "",
        "Sat O2": "",
        "Diuresi oraria": ""
      };

      // Rimuovi righe inutili: mantieni solo le righe 0-6 e l'ultima
      const righeUtili = [...rows.slice(0, 7), rows.at(-1)];

      // Popola la mappa parametri in ordine
      const nomi = Object.keys(parametriEstratti);
      for (let i = 0; i < nomi.length && i < righeUtili.length; i++) {
        parametriEstratti[nomi[i]] = righeUtili[i];
      }

      // Se PA ha forma 120/80 separa max/min
      const paMatch = righeUtili[0].match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
      if (paMatch) {
        parametriEstratti["PA Max"] = paMatch[1];
        parametriEstratti["PA Min"] = paMatch[2];
      }

      // Se PAP ha 3 numeri, estrai da riga 4
      const papLine = righeUtili[4];
      const papMatch = papLine?.match(/(\d{2,3}).*?(\d{2,3}).*?(\d{2,3})/);
      if (papMatch) {
        parametriEstratti["PAP Max"] = papMatch[1];
        parametriEstratti["PAP Min"] = papMatch[2];
        parametriEstratti["PAP Media"] = papMatch[3];
      }

      // Mostra in formato copiabile Excel (tabulato)
      let risultato = Object.keys(parametriEstratti)
        .map(k => `${k}\t${parametriEstratti[k]}`)
        .join('\n');

      document.getElementById('output').textContent = risultato;
    }
  </script>
</body>
</html>

