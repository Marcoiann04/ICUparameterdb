<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCR Buoni Mensa</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px 12px; }
  th { background-color: #eee; }
  #output { margin-top: 20px; }
  #error { color: red; margin-top: 10px; }
</style>
</head>
<body>

<h1>OCR Buoni Mensa - Estrazione dati</h1>

<input type="file" id="imgInput" accept="image/*" />
<button id="btnExtract">Estrai e Mostra</button>
<div id="error"></div>

<div id="output"></div>

<script>
  const imgInput = document.getElementById('imgInput');
  const btnExtract = document.getElementById('btnExtract');
  const output = document.getElementById('output');
  const errorDiv = document.getElementById('error');

  btnExtract.addEventListener('click', () => {
    errorDiv.textContent = '';
    output.innerHTML = '';

    if (!imgInput.files || imgInput.files.length === 0) {
      errorDiv.textContent = 'Seleziona unâ€™immagine prima di procedere.';
      return;
    }

    const file = imgInput.files[0];

    Tesseract.recognize(file, 'ita')
      .then(({ data: { text } }) => {
        if (!text || typeof text !== 'string') {
          throw new Error('Testo OCR non rilevato o non valido.');
        }

        // Pulisci il testo estratto (rimuovi spazi in eccesso e righe vuote)
        const righe = text.split('\n').map(r => r.trim()).filter(r => r.length > 0);

        // Parametri da estrarre (ordine righe):
        // 0: PA (es. "131 132" o "131\n132")
        // 1: MAP
        // 2: FC Ritmo
        // 3: PVC
        // 4: PAP Max
        // 5: PAP Min
        // 6: PAP Media
        // 7: Temperatura (singolo valore)
        // 8: Sat O2
        // 9-12: righe da saltare
        // 13: Diuresi oraria

        if (righe.length < 14) {
          throw new Error('Testo OCR insufficiente per estrazione dati.');
        }

        // Funzione di parsing base per split valori numerici da stringhe
        function parseValori(riga) {
          // prova a estrarre numeri (con virgola o punto)
          const matches = riga.match(/[\d.,]+/g);
          if (!matches) return [];
          return matches.map(v => v.replace(',', '.'));
        }

        // Estrazione PA (max e min) nella stessa riga o separate
        let paMax = '';
        let paMin = '';
        const paValori = parseValori(righe[0]);
        if (paValori.length >= 2) {
          paMax = paValori[0];
          paMin = paValori[1];
        } else if (righe.length > 1) {
          // se non in prima riga, prova seconda riga
          const paValori2 = parseValori(righe[1]);
          if (paValori2.length >= 1) {
            paMin = paValori2[0];
          }
        }

        const map = parseValori(righe[1])[0] || '';
        const fcRitmo = parseValori(righe[2])[0] || '';
        const pvc = parseValori(righe[3])[0] || '';
        const papMax = parseValori(righe[4])[0] || '';
        const papMin = parseValori(righe[5])[0] || '';
        const papMedia = parseValori(righe[6])[0] || '';
        const temperatura = parseValori(righe[7])[0] || '';
        const satO2 = parseValori(righe[8])[0] || '';
        const diuresi = parseValori(righe[13])[0] || '';

        // Mostra i dati in tabella
        output.innerHTML = `
          <table>
            <thead>
              <tr><th>Parametro</th><th>Valore</th></tr>
            </thead>
            <tbody>
              <tr><td>PA Max</td><td>${paMax}</td></tr>
              <tr><td>PA Min</td><td>${paMin}</td></tr>
              <tr><td>MAP</td><td>${map}</td></tr>
              <tr><td>FC Ritmo</td><td>${fcRitmo}</td></tr>
              <tr><td>PVC</td><td>${pvc}</td></tr>
              <tr><td>PAP Max</td><td>${papMax}</td></tr>
              <tr><td>PAP Min</td><td>${papMin}</td></tr>
              <tr><td>PAP Media</td><td>${papMedia}</td></tr>
              <tr><td>Temperatura</td><td>${temperatura}</td></tr>
              <tr><td>Sat O2</td><td>${satO2}</td></tr>
              <tr><td>Diuresi oraria</td><td>${diuresi}</td></tr>
            </tbody>
          </table>
        `;
      })
      .catch(err => {
        errorDiv.textContent = 'Errore durante l\'OCR: ' + err.message;
        console.error('Errore OCR:', err);
      });
  });
</script>

</body>
</html>

