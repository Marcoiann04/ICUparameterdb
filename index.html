<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estrazione dati da immagine con OCR automatico + Allenamento</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-top: 40px; }
  textarea { width: 100%; height: 100px; font-family: monospace; margin-top: 5px; }
  input[type="file"] { margin-top: 10px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  .container { max-width: 900px; margin: auto; }
  button { margin-top: 10px; }
  .example { background: #f0f0f0; padding: 10px; margin-top: 10px; white-space: pre-wrap; font-family: monospace; }
  #imgPreview { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; }
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Estrazione dati da immagine con OCR automatico + Allenamento</h1>

  <h2>1. Estrazione dati automatica</h2>
  <p><strong>Carica immagine:</strong></p>
  <input type="file" id="imageInput" accept="image/*" />
  <img id="imgPreview" alt="Anteprima immagine" />

  <p><strong>Testo OCR estratto (modificabile):</strong></p>
  <textarea id="ocrText"></textarea>

  <button id="extractBtn">Estrai dati dalla versione OCR</button>

  <h3>Risultato (tab separato, copia e incolla in Excel):</h3>
  <pre id="resultArea" style="background:#eee; padding:10px; white-space: pre-wrap; min-height: 100px;"></pre>

  <hr>

  <h2>2. Allenamento</h2>
  <p><strong>Incolla dati corretti copiati da Excel (tab separati):</strong></p>
  <textarea id="trainData" placeholder="Incolla qui i dati corretti da Excel"></textarea>

  <p><strong>Incolla testo OCR corrispondente (da immagine):</strong></p>
  <textarea id="trainOCR" placeholder="Incolla qui il testo OCR corrispondente"></textarea>

  <button id="saveExampleBtn">Salva esempio</button>

  <h3>Esempi salvati:</h3>
  <div id="examplesContainer"></div>
</div>

<script>
  const imageInput = document.getElementById('imageInput');
  const imgPreview = document.getElementById('imgPreview');
  const ocrText = document.getElementById('ocrText');
  const resultArea = document.getElementById('resultArea');

  // Quando carichi immagine, la mostro e lancio OCR automatico
  imageInput.addEventListener('change', () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      imgPreview.src = e.target.result;
      ocrText.value = "OCR in corso...";
      Tesseract.recognize(
        e.target.result,
        'ita',
        { logger: m => console.log(m) }
      ).then(({ data: { text } }) => {
        ocrText.value = text;
      }).catch(err => {
        ocrText.value = "";
        alert("Errore OCR: " + err);
      });
    };
    reader.readAsDataURL(file);
  });

  // Funzione base per parsare il testo OCR e estrarre i dati richiesti
  function extractData(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    let result = [];
    let i = 0;

    function parseNumbersFromLine(line) {
      let nums = line.match(/-?[\d.,]+/g);
      if (!nums) return [];
      nums = nums.map(n => n.replace(',', '.'));
      return nums;
    }

    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 2) {
        result.push(['PA_sist', nums[0]]);
        result.push(['PA_diast', nums[1]]);
        i++;
        break;
      }
      i++;
    }

    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['MAP', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['Fc_ritmo', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['PVC', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    let papValues = [];
    while (i < lines.length && papValues.length < 3) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        papValues.push(nums[0]);
        i++;
      } else {
        i++;
      }
    }
    if (papValues.length === 3) {
      result.push(['PAP_max', papValues[0]]);
      result.push(['PAP_min', papValues[1]]);
      result.push(['PAP_media', papValues[2]]);
    }

    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['T_perif_int', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    while (i < lines.length) {
      const l = lines[i];
      let percMatch = l.match(/(\d+)%/);
      if (percMatch) {
        result.push(['Sat_O2', percMatch[1]]);
        i++;
        break;
      }
      i++;
    }

    i += 4;

    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['Diuresi_oraria', nums[0]]);
        break;
      }
      i++;
    }

    let output = "Parametro\tValore\n";
    for (let r of result) {
      output += r[0] + "\t" + r[1] + "\n";
    }
    return output;
  }

  document.getElementById('extractBtn').addEventListener('click', () => {
    const text = ocrText.value.trim();
    if (!text) {
      alert("Testo OCR vuoto");
      return;
    }
    const extracted = extractData(text);
    resultArea.textContent = extracted;
  });

  // Allenamento e salvataggio esempi in localStorage
  function saveExample(ocr, data) {
    let ex = JSON.parse(localStorage.getItem('trainingExamples') || "[]");
    ex.push({ocr: ocr, data: data});
    localStorage.setItem('trainingExamples', JSON.stringify(ex));
    renderExamples();
  }

  function renderExamples() {
    let ex = JSON.parse(localStorage.getItem('trainingExamples') || "[]");
    let container = document.getElementById('examplesContainer');
    if (ex.length === 0) {
      container.innerHTML = "<i>Nessun esempio salvato.</i>";
      return;
    }
    container.innerHTML = "";
    ex.forEach((e,i) => {
      container.innerHTML += `<b>Esempio ${i+1}:</b><br><u>OCR testo:</u><br><pre class="example">${e.ocr}</pre><u>Dati Excel:</u><br><pre class="example">${e.data}</pre><hr>`;
    });
  }

  document.getElementById('saveExampleBtn').addEventListener('click', () => {
    const trainOCR = document.getElementById('trainOCR').value.trim();
    const trainData = document.getElementById('trainData').value.trim();
    if (!trainOCR || !trainData) {
      alert("Inserisci sia testo OCR che dati Excel per salvare un esempio");
      return;
    }
    saveExample(trainOCR, trainData);
    document.getElementById('trainOCR').value = "";
    document.getElementById('trainData').value = "";
  });

  window.onload = () => {
    renderExamples();
  }
</script>
</body>
</html>

