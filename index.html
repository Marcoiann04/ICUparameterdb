<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Estrazione tabella da immagine + Allenamento</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h2 { margin-top: 40px; }
  textarea { width: 100%; height: 100px; font-family: monospace; margin-top: 5px; }
  input[type="file"] { margin-top: 10px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
  .container { max-width: 900px; margin: auto; }
  button { margin-top: 10px; }
  .example { background: #f0f0f0; padding: 10px; margin-top: 10px; white-space: pre-wrap; font-family: monospace; }
</style>
</head>
<body>
<div class="container">
  <h1>Estrazione tabella da immagine + Allenamento</h1>

  <h2>1. Estrazione dati</h2>
  <p><strong>Carica immagine (opzionale, solo per riferimento):</strong></p>
  <input type="file" id="imageInput" accept="image/*" />

  <p><strong>Incolla qui il testo OCR estratto dall'immagine:</strong></p>
  <textarea id="ocrText" placeholder="Incolla qui il testo OCR"></textarea>

  <button id="extractBtn">Estrai dati</button>

  <h3>Risultato (tab separato, copia e incolla in Excel):</h3>
  <pre id="resultArea" style="background:#eee; padding:10px; white-space: pre-wrap;"></pre>

  <hr>

  <h2>2. Allenamento</h2>
  <p><strong>Incolla dati corretti copiati da Excel (tab separati):</strong></p>
  <textarea id="trainData" placeholder="Incolla qui i dati corretti da Excel"></textarea>

  <p><strong>Incolla testo OCR corrispondente (da immagine):</strong></p>
  <textarea id="trainOCR" placeholder="Incolla qui il testo OCR corrispondente"></textarea>

  <button id="saveExampleBtn">Salva esempio</button>

  <h3>Esempi salvati:</h3>
  <div id="examplesContainer"></div>
</div>

<script>
  // Funzione base per parsare il testo OCR e estrarre i dati richiesti
  // (Questo Ã¨ un esempio semplice e da migliorare)
  function extractData(text) {
    // Pulizia base: rimuove righe vuote e split per righe
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    // Ordine parametri (riga per riga) da riconoscere, secondo istruzioni utente
    // PA (sistolica e diastolica nella stessa riga, separate da spazio o slash)
    // MAP
    // Fc ritmo
    // PVC
    // PAP max, min, media (3 righe consecutive)
    // T perif/int
    // Sat O2
    // (saltare 4 righe)
    // Diuresi oraria

    let result = [];
    let i = 0;

    function parseNumbersFromLine(line) {
      // Prende i numeri in ordine dalla linea
      let nums = line.match(/-?[\d.,]+/g);
      if (!nums) return [];
      // Normalizza la virgola in punto
      nums = nums.map(n => n.replace(',', '.'));
      return nums;
    }

    // Trovo la riga PA e ricavo sistolica e diastolica (prima due numeri)
    while (i < lines.length) {
      const l = lines[i];
      // Cerco la riga PA, o quella che contiene almeno 2 numeri per PA
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 2) {
        // Potrebbe essere PA, salvo e passo
        // Rimuovo eventuali etichette a sx
        result.push(['PA_sist', nums[0]]);
        result.push(['PA_diast', nums[1]]);
        i++;
        break;
      }
      i++;
    }

    // MAP
    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['MAP', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    // Fc ritmo
    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['Fc_ritmo', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    // PVC
    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['PVC', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    // PAP max, min, media (3 righe consecutive)
    let papValues = [];
    while (i < lines.length && papValues.length < 3) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        papValues.push(nums[0]);
        i++;
      } else {
        i++;
      }
    }
    if (papValues.length === 3) {
      result.push(['PAP_max', papValues[0]]);
      result.push(['PAP_min', papValues[1]]);
      result.push(['PAP_media', papValues[2]]);
    }

    // T perif/int
    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['T_perif_int', nums[0]]);
        i++;
        break;
      }
      i++;
    }

    // Sat O2
    while (i < lines.length) {
      const l = lines[i];
      // Prendo primo numero o %
      let percMatch = l.match(/(\d+)%/);
      if (percMatch) {
        result.push(['Sat_O2', percMatch[1]]);
        i++;
        break;
      }
      i++;
    }

    // Salto 4 righe
    i += 4;

    // Diuresi oraria
    while (i < lines.length) {
      const l = lines[i];
      const nums = parseNumbersFromLine(l);
      if (nums.length >= 1) {
        result.push(['Diuresi_oraria', nums[0]]);
        break;
      }
      i++;
    }

    // Ora strutturo il risultato in tabella con intestazioni
    // Prima colonna Parametro, poi valori (qui numeri in ordine)

    // Transpose: dal formato [ [param, val], ... ] a righe e colonne
    // ma per ora ogni parametro ha un solo valore estratto: mettiamo 1 colonna valore

    let output = "Parametro\tValore\n";
    for (let r of result) {
      output += r[0] + "\t" + r[1] + "\n";
    }

    return output;
  }

  // Salvataggio esempi in localStorage
  function saveExample(ocr, data) {
    let ex = JSON.parse(localStorage.getItem('trainingExamples') || "[]");
    ex.push({ocr: ocr, data: data});
    localStorage.setItem('trainingExamples', JSON.stringify(ex));
    renderExamples();
  }

  // Mostra esempi salvati
  function renderExamples() {
    let ex = JSON.parse(localStorage.getItem('trainingExamples') || "[]");
    let container = document.getElementById('examplesContainer');
    if (ex.length === 0) {
      container.innerHTML = "<i>Nessun esempio salvato.</i>";
      return;
    }
    container.innerHTML = "";
    ex.forEach((e,i) => {
      container.innerHTML += `<b>Esempio ${i+1}:</b><br><u>OCR testo:</u><br><pre class="example">${e.ocr}</pre><u>Dati Excel:</u><br><pre class="example">${e.data}</pre><hr>`;
    });
  }

  document.getElementById('extractBtn').addEventListener('click', () => {
    const ocr = document.getElementById('ocrText').value;
    if (!ocr.trim()) {
      alert("Incolla il testo OCR per procedere");
      return;
    }
    const extracted = extractData(ocr);
    document.getElementById('resultArea').textContent = extracted;
  });

  document.getElementById('saveExampleBtn').addEventListener('click', () => {
    const trainOCR = document.getElementById('trainOCR').value.trim();
    const trainData = document.getElementById('trainData').value.trim();
    if (!trainOCR || !trainData) {
      alert("Inserisci sia testo OCR che dati Excel per salvare un esempio");
      return;
    }
    saveExample(trainOCR, trainData);
    document.getElementById('trainOCR').value = "";
    document.getElementById('trainData').value = "";
  });

  // Al caricamento pagina mostra esempi salvati
  window.onload = () => {
    renderExamples();
  }
</script>
</body>
</html>
